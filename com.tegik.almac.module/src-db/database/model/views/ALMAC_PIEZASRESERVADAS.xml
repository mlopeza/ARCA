<?xml version="1.0"?>
  <database name="VIEW ALMAC_PIEZASRESERVADAS">
    <view name="ALMAC_PIEZASRESERVADAS"><![CDATA[SELECT oldet.ventas_ordline_detail_id AS almac_piezasreservadas_id, oldet.ad_client_id, oldet.ad_org_id, oldet.isactive, oldet.created, oldet.createdby, oldet.updated, oldet.updatedby, ol.m_product_id, o.m_warehouse_id, COALESCE(oldet.qty, 0) AS ordenado, COALESCE(oldet.qty - COALESCE(hd.qtydelivered, 0), 0) AS reservado, o.c_order_id, ol.c_orderline_id, oldet.m_attributesetinstance_id, "substring"(ol.m_product_id, 17) || "substring"(o.m_warehouse_id, 17) AS almac_productosalmacenados_id, o.c_bpartner_id, o.salesrep_id FROM ventas_ordline_detail oldet JOIN c_orderline ol ON oldet.c_orderline_id = ol.c_orderline_id JOIN m_storage_detail sd ON sd.m_attributesetinstance_id = oldet.m_attributesetinstance_id JOIN c_order o ON o.c_order_id = ol.c_order_id AND (o.docstatus IN ('CO', 'IP')) AND o.issotrx = 'Y' LEFT JOIN (SELECT hd2.ventas_ordline_detail_id, sum(hd2.qty) AS facturado, sum(iol.movementqty) AS qtydelivered FROM ventas_historial_desgloce hd2 JOIN m_inoutline iol ON iol.m_inoutline_id = hd2.m_inoutline_id AND (iol.m_inout_id IN (SELECT m_inout.m_inout_id FROM m_inout WHERE m_inout.docstatus = 'CO')) GROUP BY hd2.ventas_ordline_detail_id) hd ON hd.ventas_ordline_detail_id = oldet.ventas_ordline_detail_id WHERE COALESCE(oldet.qty - COALESCE(hd.qtydelivered, 0), 0) > 0 AND sd.qtyonhand > 0 ORDER BY o.dateordered, o.documentno, ol.line]]></view>
  </database>
