<?xml version="1.0"?>
  <database name="VIEW ALMAC_CATALOGO_P">
    <view name="ALMAC_CATALOGO_P"><![CDATA[SELECT p.m_product_id AS almac_catalogo_p_id, p.ad_client_id, p.ad_org_id, p.isactive, p.created, p.createdby, p.updated, p.updatedby, p.name, p.value, pc.name AS category, COALESCE(alm.almacenado, 0) AS almacenado_monterrey, COALESCE(trm.transito, 0) AS en_transito_monterrey, COALESCE(ald.almacenado, 0) AS almacenado_df, COALESCE(trd.transito, 0) AS en_transito_df, COALESCE(conexmty.dias_transito, 0) AS dias_mty, COALESCE(conexdf.dias_transito, 0) AS dias_df, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'DF', 'M'), 4) AS preciomin_usd_df, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'DF', 'I'), 4) AS precioideal_usd_df, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'MTY', 'M'), 4) AS preciomin_usd_mty, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'MTY', 'I'), 4) AS precioideal_usd_mty, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'DF', 'M') * cl.em_almac_crate_usdmxn, 4) AS preciomin_mxn_df, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'DF', 'I') * cl.em_almac_crate_usdmxn, 4) AS precioideal_mxn_df, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'MTY', 'M') * cl.em_almac_crate_usdmxn, 4) AS preciomin_mxn_mty, round(almac_calcula_costo(p.m_product_id, NULL, NULL, 'MTY', 'I') * cl.em_almac_crate_usdmxn, 4) AS precioideal_mxn_mty FROM (SELECT product.m_product_id, product.ad_client_id, product.ad_org_id, product.isactive, product.created, product.createdby, product.updated, product.updatedby, product.value, product.name, product.sku, product.c_uom_id, product.m_product_category_id, product.m_attributeset_id, product.m_attributesetinstance_id, product.name2, product.ma_processplan_id, product.em_dmprod_tipopiedra_id, product.em_dmprod_uso_id, product.em_dmprod_areauso_id, product.em_dmprod_color_id, product.em_dmprod_country_id, product.em_dmprod_tileoslab, product.em_dmprod_acabado, product.em_dmprod_isoutlet, product.em_dmprod_height, product.em_dmprod_width, product.em_dmprod_isarancel, product.em_dmprod_preciofob, product.em_dmprod_arancel, product.em_ventas_isantic, product.em_dmprod_depth, product.em_almac_estilo_id, product.em_almac_aplicacion_id, product.em_almac_uso_recom_id, product.em_almac_seg_recom_id, product.em_almac_tipo_medida_id, product.em_almac_cons_ton_id, product.em_almac_cons_veta_id, product.em_almac_q_production_id, product.em_almac_cat_piedra_id, product.em_almac_disp_prod_id, product.em_almac_c_currency_id, product.em_almac_puertos_id, product.em_almac_nombre_origen, product.em_almac_fob_usd, 24000 / (3000 * COALESCE(product.em_dmprod_depth, 0.00000000000001)) AS c2, COALESCE(product.em_almac_fob_usd, 0) AS c3,  CASE WHEN round(product.em_dmprod_arancel, 4) = round(0, 4) THEN COALESCE(product.em_dmprod_arancel, 0) ELSE round(COALESCE(product.em_dmprod_arancel / 100, 0), 4) END AS c4 FROM m_product product WHERE upper(product.em_dmprod_tileoslab) IN ('TILE', 'SLAB')) p LEFT JOIN ad_client cl ON cl.ad_client_id = '0BD13E24E0F94596B61414BD72225EB8' AND cl.ad_client_id = p.ad_client_id LEFT JOIN (SELECT sd.m_product_id, round(COALESCE(sum(sd.qtyonhand), 0), 4) AS almacenado FROM m_storage_detail sd JOIN m_locator loc ON loc.m_locator_id = sd.m_locator_id JOIN m_warehouse w ON w.m_warehouse_id = loc.m_warehouse_id AND w.em_almac_esmonterrey = 'Y' JOIN m_attributesetinstance asi ON asi.m_attributesetinstance_id = sd.m_attributesetinstance_id AND asi.em_almac_reservapedido = 'N' AND asi.em_almac_reservacotizacion = 'N' GROUP BY sd.m_product_id) alm ON alm.m_product_id = p.m_product_id LEFT JOIN (SELECT pl.m_product_id, sum(COALESCE(pl.quantity, 0)) AS transito FROM compra_packinglist pl JOIN compra_contenedor c ON pl.compra_contenedor_id = c.compra_contenedor_id AND c.estado = 'CO' JOIN m_warehouse w ON w.m_warehouse_id = c.m_warehouse_id AND w.em_almac_esmonterrey = 'Y' GROUP BY pl.m_product_id) trm ON trm.m_product_id = p.m_product_id LEFT JOIN (SELECT sd.m_product_id, round(COALESCE(sum(sd.qtyonhand), 0), 4) AS almacenado FROM m_storage_detail sd JOIN m_locator loc ON loc.m_locator_id = sd.m_locator_id JOIN m_warehouse w ON w.m_warehouse_id = loc.m_warehouse_id AND w.em_almac_esdf = 'Y' JOIN m_attributesetinstance asi ON asi.m_attributesetinstance_id = sd.m_attributesetinstance_id AND asi.em_almac_reservapedido = 'N' AND asi.em_almac_reservacotizacion = 'N' GROUP BY sd.m_product_id) ald ON ald.m_product_id = p.m_product_id LEFT JOIN (SELECT pl.m_product_id, sum(COALESCE(pl.quantity, 0)) AS transito FROM compra_packinglist pl JOIN compra_contenedor c ON pl.compra_contenedor_id = c.compra_contenedor_id AND c.estado = 'CO' JOIN m_warehouse w ON w.m_warehouse_id = c.m_warehouse_id AND w.em_almac_esdf = 'Y' GROUP BY pl.m_product_id) trd ON trd.m_product_id = p.m_product_id LEFT JOIN (SELECT COALESCE(category.name, category.value, '') AS name, category.m_product_category_id, category.em_almac_margen_minimo, category.em_almac_margen_ideal, category.em_almac_comision,  CASE WHEN round(category.em_almac_margen_minimo, 4) = round(0, 4) THEN COALESCE(category.em_almac_margen_minimo, 0) ELSE round(COALESCE(category.em_almac_margen_minimo / 100, 0), 4) END AS margen_minimo,  CASE WHEN round(category.em_almac_margen_ideal, 4) = round(0, 4) THEN COALESCE(category.em_almac_margen_ideal, 0) ELSE round(COALESCE(category.em_almac_margen_ideal / 100, 0), 4) END AS margen_ideal FROM m_product_category category) pc ON p.m_product_category_id = pc.m_product_category_id LEFT JOIN (SELECT x.m_product_id, COALESCE(y.dias_transito, 0) + COALESCE(y.dias_despacho, 0) AS dias_transito, COALESCE(y.tarifa_flete_mar_usd, 0) AS tarifa_flete_mar_usd, COALESCE(y.maniobras, 0) + COALESCE(y.honorarios, 0) + COALESCE(y.tarifa_flete_terrestre, 0) AS indirectos FROM almac_conex_prod x JOIN almac_puertos_conexion y ON x.almac_puertos_conexion_id = y.almac_puertos_conexion_id AND x.name LIKE '%MTY%') conexmty ON conexmty.m_product_id = p.m_product_id LEFT JOIN (SELECT x.m_product_id, COALESCE(y.dias_transito, 0) + COALESCE(y.dias_despacho, 0) AS dias_transito, COALESCE(y.tarifa_flete_mar_usd, 0) AS tarifa_flete_mar_usd, COALESCE(y.maniobras, 0) + COALESCE(y.honorarios, 0) + COALESCE(y.tarifa_flete_terrestre, 0) AS indirectos FROM almac_conex_prod x JOIN almac_puertos_conexion y ON x.almac_puertos_conexion_id = y.almac_puertos_conexion_id AND x.name LIKE '%DF%') conexdf ON conexdf.m_product_id = p.m_product_id WHERE p.m_product_id IS NOT NULL]]></view>
  </database>
