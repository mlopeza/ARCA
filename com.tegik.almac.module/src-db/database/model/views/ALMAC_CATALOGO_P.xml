<?xml version="1.0"?>
  <database name="VIEW ALMAC_CATALOGO_P">
    <view name="ALMAC_CATALOGO_P"><![CDATA[SELECT p.m_product_id AS almac_catalogo_p_id, p.ad_client_id, p.ad_org_id, p.isactive, p.created, p.createdby, p.updated, p.updatedby, p.name, p.value, pc.name AS category, COALESCE(alm.almacenado, 0) AS almacenado_monterrey, COALESCE(trm.transito, 0) AS en_transito_monterrey, COALESCE(ald.almacenado, 0) AS almacenado_df, COALESCE(trd.transito, 0) AS en_transito_df, COALESCE(conexmty.dias_transito, 0) + COALESCE(conexmty.dias_despacho, 0) AS dias_mty, COALESCE(conexdf.dias_transito, 0) + COALESCE(conexdf.dias_despacho, 0) AS dias_df, COALESCE(round((conexdf.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexdf.c5 / p.c2) + 0.008 * (p.c3 + conexdf.c5 / p.c2) + 0.01 * (p.c3 + conexdf.c5 / p.c2)) / (1.0000001 - pc.margen_minimo), 4), 0) AS preciomin_usd_df, COALESCE(round((conexdf.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexdf.c5 / p.c2) + 0.008 * (p.c3 + conexdf.c5 / p.c2) + 0.01 * (p.c3 + conexdf.c5 / p.c2)) / (1.0000001 - pc.margen_ideal), 4), 0) AS precioideal_usd_df, COALESCE(round((conexmty.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexmty.c5 / p.c2) + 0.008 * (p.c3 + conexmty.c5 / p.c2) + 0.01 * (p.c3 + conexmty.c5 / p.c2)) / (1.0000001 - pc.margen_minimo), 4), 0) AS preciomin_usd_mty, COALESCE(round((conexmty.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexmty.c5 / p.c2) + 0.008 * (p.c3 + conexmty.c5 / p.c2) + 0.01 * (p.c3 + conexmty.c5 / p.c2)) / (1.00000001 - pc.margen_ideal), 4), 0) AS precioideal_usd_mty, COALESCE(round((conexdf.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexdf.c5 / p.c2) + 0.008 * (p.c3 + conexdf.c5 / p.c2) + 0.01 * (p.c3 + conexdf.c5 / p.c2)) / (1.0000001 - pc.margen_minimo), 4) * cl.em_almac_crate_usdmxn, 0) AS preciomin_mxn_df, COALESCE(round((conexdf.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexdf.c5 / p.c2) + 0.008 * (p.c3 + conexdf.c5 / p.c2) + 0.01 * (p.c3 + conexdf.c5 / p.c2)) / (1.0000001 - pc.margen_ideal), 4) * cl.em_almac_crate_usdmxn, 0) AS precioideal_mxn_df, COALESCE(round((conexmty.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexmty.c5 / p.c2) + 0.008 * (p.c3 + conexmty.c5 / p.c2) + 0.01 * (p.c3 + conexmty.c5 / p.c2)) / (1.0000001 - pc.margen_minimo), 4) * cl.em_almac_crate_usdmxn, 0) AS preciomin_mxn_mty, COALESCE(round((conexmty.c1 / p.c2 + p.c3 + p.c4 * (p.c3 + conexmty.c5 / p.c2) + 0.008 * (p.c3 + conexmty.c5 / p.c2) + 0.01 * (p.c3 + conexmty.c5 / p.c2)) / (1.00000001 - pc.margen_ideal), 4) * cl.em_almac_crate_usdmxn, 0) AS precioideal_mxn_mty FROM (SELECT product.m_product_id, product.ad_client_id, product.ad_org_id, product.isactive, product.created, product.createdby, product.updated, product.updatedby, product.value, product.name, product.sku, product.c_uom_id, product.m_product_category_id, product.m_attributeset_id, product.m_attributesetinstance_id, product.name2, product.ma_processplan_id, product.em_dmprod_tipopiedra_id, product.em_dmprod_uso_id, product.em_dmprod_areauso_id, product.em_dmprod_color_id, product.em_dmprod_country_id, product.em_dmprod_tileoslab, product.em_dmprod_acabado, product.em_dmprod_isoutlet, product.em_dmprod_height, product.em_dmprod_width, product.em_dmprod_isarancel, product.em_dmprod_preciofob, product.em_dmprod_arancel, product.em_ventas_isantic, product.em_dmprod_depth, product.em_almac_estilo_id, product.em_almac_aplicacion_id, product.em_almac_uso_recom_id, product.em_almac_seg_recom_id, product.em_almac_tipo_medida_id, product.em_almac_cons_ton_id, product.em_almac_cons_veta_id, product.em_almac_q_production_id, product.em_almac_cat_piedra_id, product.em_almac_disp_prod_id, product.em_almac_c_currency_id, product.em_almac_puertos_id, product.em_almac_nombre_origen, product.em_almac_fob_usd, 24000 / (3000 * COALESCE(product.em_dmprod_depth, 0.00000000000001)) AS c2, COALESCE(product.em_almac_fob_usd, 0) AS c3,  CASE WHEN round(product.em_dmprod_arancel, 4) = round(0, 4) THEN COALESCE(product.em_dmprod_arancel, 0) ELSE round(COALESCE(product.em_dmprod_arancel / 100, 0), 4) END AS c4 FROM m_product product WHERE upper(product.em_dmprod_tileoslab) IN ('TILE', 'SLAB')) p LEFT JOIN ad_client cl ON cl.ad_client_id = '0BD13E24E0F94596B61414BD72225EB8' AND cl.ad_client_id = p.ad_client_id LEFT JOIN (SELECT almac_piezasalmacenadas.m_product_id, round(sum(almac_piezasalmacenadas.m2), 4) AS almacenado FROM almac_piezasalmacenadas WHERE almac_piezasalmacenadas.reserva_pedido = 'N' AND almac_piezasalmacenadas.reserva_cotizacion = 'N' AND btrim(upper(almac_piezasalmacenadas.status)) = 'ALMACENADO' AND almac_piezasalmacenadas.em_almac_esmonterrey = 'Y' GROUP BY almac_piezasalmacenadas.m_product_id) alm ON alm.m_product_id = p.m_product_id LEFT JOIN (SELECT almac_piezasalmacenadas.m_product_id, round(sum(almac_piezasalmacenadas.m2), 4) AS transito FROM almac_piezasalmacenadas WHERE almac_piezasalmacenadas.reserva_pedido = 'N' AND almac_piezasalmacenadas.reserva_cotizacion = 'N' AND btrim(upper(almac_piezasalmacenadas.status)) = 'TRANSITO' AND almac_piezasalmacenadas.em_almac_esmonterrey = 'Y' GROUP BY almac_piezasalmacenadas.m_product_id) trm ON trm.m_product_id = p.m_product_id LEFT JOIN (SELECT almac_piezasalmacenadas.m_product_id, round(sum(almac_piezasalmacenadas.m2), 4) AS almacenado FROM almac_piezasalmacenadas WHERE almac_piezasalmacenadas.reserva_pedido = 'N' AND almac_piezasalmacenadas.reserva_cotizacion = 'N' AND btrim(upper(almac_piezasalmacenadas.status)) = 'ALMACENADO' AND almac_piezasalmacenadas.em_almac_esdf = 'Y' GROUP BY almac_piezasalmacenadas.m_product_id) ald ON ald.m_product_id = p.m_product_id LEFT JOIN (SELECT almac_piezasalmacenadas.m_product_id, round(sum(almac_piezasalmacenadas.m2), 4) AS transito FROM almac_piezasalmacenadas WHERE almac_piezasalmacenadas.reserva_pedido = 'N' AND almac_piezasalmacenadas.reserva_cotizacion = 'N' AND btrim(upper(almac_piezasalmacenadas.status)) = 'TRANSITO' AND almac_piezasalmacenadas.em_almac_esdf = 'Y' GROUP BY almac_piezasalmacenadas.m_product_id) trd ON trd.m_product_id = p.m_product_id LEFT JOIN (SELECT COALESCE(category.name, category.value, '') AS name, category.m_product_category_id, category.em_almac_margen_minimo, category.em_almac_margen_ideal, category.em_almac_comision,  CASE WHEN round(category.em_almac_margen_minimo, 4) = round(0, 4) THEN COALESCE(category.em_almac_margen_minimo, 0) ELSE round(COALESCE(category.em_almac_margen_minimo / 100, 0), 4) END AS margen_minimo,  CASE WHEN round(category.em_almac_margen_ideal, 4) = round(0, 4) THEN COALESCE(category.em_almac_margen_ideal, 0) ELSE round(COALESCE(category.em_almac_margen_ideal / 100, 0), 4) END AS margen_ideal FROM m_product_category category) pc ON p.m_product_category_id = pc.m_product_category_id LEFT JOIN (SELECT acp.almac_conex_prod_id, acp.m_product_id, acp.almac_puertos_conexion_id, acp.ad_client_id, acp.ad_org_id, acp.isactive, acp.created, acp.createdby, acp.updated, acp.updatedby, acp.name, acp.description, apc.almac_puertos_conexion_id, apc.ad_client_id, apc.ad_org_id, apc.isactive, apc.created, apc.createdby, apc.updated, apc.updatedby, apc.name, apc.desde_puerto, apc.hasta_puerto, apc.c_country_id, apc.c_city_id, apc.dias_transito, apc.dias_despacho, apc.tarifa_flete_mar_usd, apc.maniobras, apc.honorarios, apc.tarifa_flete_terrestre, apc.porcentaje_seguro, COALESCE(COALESCE(apc.maniobras, 0) + COALESCE(apc.honorarios, 0) + COALESCE(apc.tarifa_flete_terrestre, 0) + COALESCE(apc.tarifa_flete_mar_usd, 0), 0) AS c1, COALESCE(apc.tarifa_flete_mar_usd, 0) AS c5 FROM almac_conex_prod acp JOIN almac_puertos_conexion apc ON apc.almac_puertos_conexion_id = acp.almac_puertos_conexion_id AND upper(btrim(apc.name)) LIKE '%DF') conexdf ON conexdf.m_product_id = p.m_product_id LEFT JOIN (SELECT acp.almac_conex_prod_id, acp.m_product_id, acp.almac_puertos_conexion_id, acp.ad_client_id, acp.ad_org_id, acp.isactive, acp.created, acp.createdby, acp.updated, acp.updatedby, acp.name, acp.description, apc.almac_puertos_conexion_id, apc.ad_client_id, apc.ad_org_id, apc.isactive, apc.created, apc.createdby, apc.updated, apc.updatedby, apc.name, apc.desde_puerto, apc.hasta_puerto, apc.c_country_id, apc.c_city_id, apc.dias_transito, apc.dias_despacho, apc.tarifa_flete_mar_usd, apc.maniobras, apc.honorarios, apc.tarifa_flete_terrestre, apc.porcentaje_seguro, COALESCE(apc.maniobras, 0) + COALESCE(apc.honorarios, 0) + COALESCE(apc.tarifa_flete_terrestre, 0) + COALESCE(apc.tarifa_flete_mar_usd, 0) AS c1, COALESCE(apc.tarifa_flete_mar_usd, 0) AS c5 FROM almac_conex_prod acp JOIN almac_puertos_conexion apc ON apc.almac_puertos_conexion_id = acp.almac_puertos_conexion_id AND upper(btrim(apc.name)) LIKE '%MTY') conexmty ON conexmty.m_product_id = p.m_product_id WHERE p.m_product_id IS NOT NULL]]></view>
  </database>
