<?xml version="1.0"?>
  <database name="VIEW ALMAC_PIEZASCONPRECIO">
    <view name="ALMAC_PIEZASCONPRECIO"><![CDATA[SELECT px.ventas_reservas_v_id AS almac_piezasconprecio_id, px.m_attributesetinstance_id, px.ad_client_id, px.ad_org_id, px.createdby, px.updatedby, px.created, px.updated, px.isactive, px.cantreservada, px.prefijo, px.numero, px.ventas_pickexecute_id, px.reserva_pedido, px.reserva_cotizacion, px.numero_pedido, px.numero_cotizacion, px.ob_selected, px.cantidad2, px.m_product_id, px.m_warehouse_id, px.status, cc.documentno AS contenedor, cc.pedimento, p.name AS nombre_producto, p.name2 AS nombre_real, p.em_almac_nombre_origen AS nombre_origen, p.value AS codigo_producto, pc.name AS categoria, asi.description AS atributo, round(px.cantidad2, 4) AS m2,  CASE WHEN btrim(upper(p.em_dmprod_tileoslab)) = 'TILE' THEN round(px.cantidad2 / (p.em_dmprod_height * p.em_dmprod_width), 4) ELSE 1 END AS cantidad, COALESCE(wh.name, 'EN TRANSITO') AS almacen, COALESCE((SELECT pp.pricelist FROM m_productprice pp WHERE pp.m_product_id = sdt.m_product_id AND (pp.m_pricelist_version_id IN (SELECT m_pricelist_version.m_pricelist_version_id FROM m_pricelist_version WHERE upper(m_pricelist_version.name) = 'VENTA EN DOLARES' LIMIT 1)) LIMIT 1), 0) AS m2_precio, round(COALESCE(COALESCE((SELECT pp.pricelist FROM m_productprice pp WHERE pp.m_product_id = sdt.m_product_id AND (pp.m_pricelist_version_id IN (SELECT m_pricelist_version.m_pricelist_version_id FROM m_pricelist_version WHERE upper(m_pricelist_version.name) = 'VENTA EN DOLARES' LIMIT 1)) LIMIT 1), 0) * COALESCE(p.em_dmprod_height * p.em_dmprod_width, 0), 0), 4) AS total, COALESCE(NULL, 'M2') AS unidad_medida, tp.name AS tipo_piedra, p.em_dmprod_tileoslab AS formato, p.em_dmprod_height * p.em_dmprod_width AS area, p.em_dmprod_acabado AS acabado, acp.name AS categoria_piedra, acap.name AS calidad_producto, adp.name AS disponibilidad_produccion, aqp.name AS calidad_produccion, acv.name AS consistencia_veta, act.name AS consistencia_tonalidad, atp.name AS tipo_medida,  CASE WHEN btrim(upper(p.em_dmprod_tileoslab)) = 'TILE' THEN p.em_dmprod_height ELSE px.alto END AS largo,  CASE WHEN btrim(upper(p.em_dmprod_tileoslab)) = 'TILE' THEN p.em_dmprod_width ELSE px.ancho END AS ancho, p.em_dmprod_depth AS espesor, COALESCE(p.em_dmprod_preciofob, 0) AS costo_fob, cur.iso_code AS moneda_compra, p.em_almac_crate_usdeur AS tc_eur_usd, p.em_almac_fob_usd AS costos_fob_usd, co.name AS pais_origen, COALESCE(p.em_dmprod_arancel, 0) AS arancel, apc.name AS puerto_embarque, COALESCE(0, p.stockmin) AS stock_minimo, asr.name AS segmento_recomendado, uso.name AS uso_recomendado, ap.name AS aplicacion, color.name AS color, ae.name AS estilo, area.name AS area_producto, COALESCE(NULL, 'M2') AS unidad_metrica, conexmty.tarifa_flete_mar_usd AS indirecto_flete_m_mty, conexdf.tarifa_flete_mar_usd AS indirecto_flete_m_df, conexmty.indirectos AS otros_indirectos_mty, conexdf.indirectos AS otros_indirectos_df, conexdf.dias_transito AS dias_transito_df, conexmty.dias_transito AS dias_transito_mty, COALESCE(asi.em_almac_costo_realusd, 0) AS cr_sud_lab_df, COALESCE(pc.em_almac_margen_minimo, 0) AS margen_minimo, COALESCE(pc.em_almac_margen_ideal, 0) AS margen_ideal, COALESCE(pc.em_almac_comision, 0) AS p_comision_pagar, p.c_usd_lab_df, p.c_usd_lab_mty, p.preciomin_usd_df, p.precioideal_usd_df, p.preciomin_usd_mty, p.precioideal_usd_mty, p.preciomin_mxn_df, p.precioideal_mxn_df, p.preciomin_mxn_mty, p.precioideal_mxn_mty, almac_fecha_llegada(p.m_product_id, px.compra_contenedor_id, px.m_warehouse_id, px.ingresado) AS fecha_llegada FROM (SELECT  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN sd.m_storage_detail_id ELSE pl.compra_packinglist_id END AS ventas_reservas_v_id, asi.m_attributesetinstance_id, asi.ad_client_id, asi.ad_org_id, asi.createdby, asi.updatedby, asi.created, asi.updated, asi.isactive, 0.00 AS cantreservada, asi.em_almac_prefijo AS prefijo, asi.em_almac_numero AS numero, asi.em_ventas_pickexecute_id AS ventas_pickexecute_id, asi.em_almac_reservapedido AS reserva_pedido, asi.em_almac_reservacotizacion AS reserva_cotizacion, asi.em_almac_numpedido AS numero_pedido, asi.em_almac_numcotizacion AS numero_cotizacion, asi.em_almac_alto AS alto, asi.em_almac_ancho AS ancho, COALESCE(asi.em_almac_ingresado, 'N') AS ingresado, to_char('N') AS ob_selected,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN sd.qtyonhand ELSE pl.quantity END AS cantidad2,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN sd.m_product_id ELSE pl.m_product_id END AS m_product_id,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN wh.m_warehouse_id ELSE pl.m_warehouse_id END AS m_warehouse_id,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN 'ALMACENADO' ELSE 'TRANSITO' END AS status,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN asi.em_almac_com_contenedor_id ELSE pl.compra_contenedor_id END AS compra_contenedor_id FROM m_attributesetinstance asi LEFT JOIN (SELECT m_storage_detail.m_storage_detail_id, m_storage_detail.m_product_id, m_storage_detail.m_attributesetinstance_id, m_storage_detail.m_locator_id, m_storage_detail.qtyonhand FROM m_storage_detail WHERE round(m_storage_detail.qtyonhand, 4) > 0 AND m_storage_detail.m_attributesetinstance_id <> '0' AND m_storage_detail.ad_client_id = '0BD13E24E0F94596B61414BD72225EB8') sd ON sd.m_attributesetinstance_id = asi.m_attributesetinstance_id LEFT JOIN m_locator l ON l.m_locator_id = sd.m_locator_id LEFT JOIN m_warehouse wh ON wh.m_warehouse_id = l.m_warehouse_id LEFT JOIN (SELECT pl.m_attributesetinstance_id, pl.compra_packinglist_id, pl.quantity, pl.m_product_id, c.m_warehouse_id, c.compra_contenedor_id FROM compra_packinglist pl JOIN compra_contenedor c ON c.estado = 'CO' AND pl.compra_contenedor_id = c.compra_contenedor_id) pl ON pl.m_attributesetinstance_id = asi.m_attributesetinstance_id WHERE  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN sd.m_storage_detail_id ELSE pl.compra_packinglist_id END IS NOT NULL) px JOIN (SELECT prod.m_product_id, prod.ad_client_id, prod.ad_org_id, prod.isactive, prod.created, prod.createdby, prod.updated, prod.updatedby, prod.value, prod.name, prod.description, prod.documentnote, prod.help, prod.upc, prod.sku, prod.c_uom_id, prod.salesrep_id, prod.issummary, prod.isstocked, prod.ispurchased, prod.issold, prod.isbom, prod.isinvoiceprintdetails, prod.ispicklistprintdetails, prod.isverified, prod.m_product_category_id, prod.classification, prod.volume, prod.weight, prod.shelfwidth, prod.shelfheight, prod.shelfdepth, prod.unitsperpallet, prod.c_taxcategory_id, prod.s_resource_id, prod.discontinued, prod.discontinuedby, prod.processing, prod.s_expensetype_id, prod.producttype, prod.imageurl, prod.descriptionurl, prod.guaranteedays, prod.versionno, prod.m_attributeset_id, prod.m_attributesetinstance_id, prod.downloadurl, prod.m_freightcategory_id, prod.m_locator_id, prod.ad_image_id, prod.c_bpartner_id, prod.ispriceprinted, prod.name2, prod.costtype, prod.coststd, prod.stock_min, prod.enforce_attribute, prod.calculated, prod.ma_processplan_id, prod.production, prod.capacity, prod.delaymin, prod.mrp_planner_id, prod.mrp_planningmethod_id, prod.qtymax, prod.qtymin, prod.qtystd, prod.qtytype, prod.stockmin, prod.attrsetvaluetype, prod.isquantityvariable, prod.em_dmprod_tipopiedra_id, prod.em_dmprod_uso_id, prod.em_dmprod_areauso_id, prod.em_dmprod_color_id, prod.em_dmprod_country_id, prod.em_dmprod_tileoslab, prod.em_dmprod_acabado, prod.em_dmprod_isoutlet, prod.em_dmprod_height, prod.em_dmprod_width, prod.em_dmprod_isarancel, prod.em_dmprod_preciofob, prod.em_dmprod_arancel, prod.em_ventas_isantic, prod.em_almac_fob_usd, prod.em_almac_nombre_origen, prod.em_almac_puertos_id, prod.em_almac_c_currency_id, prod.em_almac_disp_prod_id, prod.em_almac_cat_piedra_id, prod.em_almac_q_production_id, prod.em_almac_cons_veta_id, prod.em_almac_cons_ton_id, prod.em_almac_tipo_medida_id, prod.em_almac_seg_recom_id, prod.em_almac_uso_recom_id, prod.em_almac_aplicacion_id, prod.em_almac_estilo_id, prod.em_dmprod_depth, cl.em_almac_crate_usdeur, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'DF', '0'), 4) AS c_usd_lab_df, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'MTY', '0'), 4) AS c_usd_lab_mty, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'DF', 'M'), 4) AS preciomin_usd_df, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'DF', 'I'), 4) AS precioideal_usd_df, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'MTY', 'M'), 4) AS preciomin_usd_mty, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'MTY', 'I'), 4) AS precioideal_usd_mty, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'DF', 'M') * cl.em_almac_crate_usdmxn, 4) AS preciomin_mxn_df, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'DF', 'I') * cl.em_almac_crate_usdmxn, 4) AS precioideal_mxn_df, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'MTY', 'M') * cl.em_almac_crate_usdmxn, 4) AS preciomin_mxn_mty, round(almac_calcula_costo(prod.m_product_id, NULL, NULL, 'MTY', 'I') * cl.em_almac_crate_usdmxn, 4) AS precioideal_mxn_mty FROM m_product prod JOIN ad_client cl ON prod.ad_client_id = cl.ad_client_id AND cl.ad_client_id = '0BD13E24E0F94596B61414BD72225EB8' AND (upper(prod.em_dmprod_tileoslab) IN ('TILE', 'SLAB')) AND prod.isactive = 'Y') p ON p.m_product_id = px.m_product_id LEFT JOIN dmprod_tipopiedra tp ON tp.dmprod_tipopiedra_id = p.em_dmprod_tipopiedra_id LEFT JOIN m_product_category pc ON p.m_product_category_id = pc.m_product_category_id LEFT JOIN (SELECT co.c_country_id, cotrl.name FROM c_country co JOIN c_country_trl cotrl ON co.c_country_id = cotrl.c_country_id AND cotrl.ad_language = 'es_ES') co ON p.em_dmprod_country_id = co.c_country_id LEFT JOIN dmprod_uso uso ON p.em_dmprod_uso_id = uso.dmprod_uso_id LEFT JOIN dmprod_areauso area ON p.em_dmprod_areauso_id = area.dmprod_areauso_id LEFT JOIN dmprod_color color ON color.dmprod_color_id = p.em_dmprod_color_id LEFT JOIN almac_estilo ae ON ae.almac_estilo_id = p.em_almac_estilo_id LEFT JOIN almac_aplicacion ap ON p.em_almac_aplicacion_id = ap.almac_aplicacion_id LEFT JOIN almac_uso_recom aur ON p.em_almac_uso_recom_id = aur.almac_uso_recom_id LEFT JOIN almac_seg_recom asr ON asr.almac_seg_recom_id = p.em_almac_seg_recom_id LEFT JOIN almac_tipo_medida atp ON atp.almac_tipo_medida_id = p.em_almac_tipo_medida_id LEFT JOIN almac_cons_ton act ON p.em_almac_cons_ton_id = act.almac_cons_ton_id LEFT JOIN almac_cons_veta acv ON p.em_almac_cons_veta_id = acv.almac_cons_veta_id LEFT JOIN almac_q_production aqp ON p.em_almac_q_production_id = aqp.almac_q_production_id LEFT JOIN almac_disp_prod adp ON p.em_almac_disp_prod_id = adp.almac_disp_prod_id LEFT JOIN almac_puertos apc ON p.em_almac_puertos_id = apc.almac_puertos_id LEFT JOIN m_storage_detail sdt ON px.ventas_reservas_v_id = sdt.m_storage_detail_id LEFT JOIN m_locator loc ON loc.m_locator_id = sdt.m_locator_id LEFT JOIN m_warehouse wh ON wh.m_warehouse_id = loc.m_warehouse_id LEFT JOIN m_product_category acp ON p.m_product_category_id = acp.m_product_category_id LEFT JOIN m_attributesetinstance asi ON asi.m_attributesetinstance_id = px.m_attributesetinstance_id LEFT JOIN almac_calidad_p acap ON acap.almac_calidad_p_id = asi.em_almac_calidad_p_id LEFT JOIN compra_contenedor cc ON cc.compra_contenedor_id = px.compra_contenedor_id LEFT JOIN c_currency cur ON cur.c_currency_id = p.em_almac_c_currency_id LEFT JOIN (SELECT x.m_product_id, COALESCE(y.dias_transito, 0) + COALESCE(y.dias_despacho, 0) AS dias_transito, COALESCE(y.tarifa_flete_mar_usd, 0) AS tarifa_flete_mar_usd, COALESCE(y.maniobras, 0) + COALESCE(y.honorarios, 0) + COALESCE(y.tarifa_flete_terrestre, 0) AS indirectos FROM almac_conex_prod x JOIN almac_puertos_conexion y ON x.almac_puertos_conexion_id = y.almac_puertos_conexion_id AND x.name LIKE '%MTY%') conexmty ON conexmty.m_product_id = p.m_product_id LEFT JOIN (SELECT x.m_product_id, COALESCE(y.dias_transito, 0) + COALESCE(y.dias_despacho, 0) AS dias_transito, COALESCE(y.tarifa_flete_mar_usd, 0) AS tarifa_flete_mar_usd, COALESCE(y.maniobras, 0) + COALESCE(y.honorarios, 0) + COALESCE(y.tarifa_flete_terrestre, 0) AS indirectos FROM almac_conex_prod x JOIN almac_puertos_conexion y ON x.almac_puertos_conexion_id = y.almac_puertos_conexion_id AND x.name LIKE '%DF%') conexdf ON conexdf.m_product_id = p.m_product_id WHERE px.m_product_id IS NOT NULL]]></view>
  </database>
