<?xml version="1.0"?>
  <database name="VIEW ALMAC_PRODALMACENDET">
    <view name="ALMAC_PRODALMACENDET"><![CDATA[SELECT "substring"(p.m_product_id, 17) || "substring"(wh.m_warehouse_id, 17) AS almac_prodalmacendet_id, sd.ad_client_id, (SELECT ad_client.ad_org_id FROM ad_client WHERE ad_client.ad_client_id = sd.ad_client_id) AS ad_org_id, (SELECT ad_client.isactive FROM ad_client WHERE ad_client.ad_client_id = sd.ad_client_id) AS isactive, now() AS created, (SELECT ad_client.createdby FROM ad_client WHERE ad_client.ad_client_id = sd.ad_client_id) AS createdby, now() AS updated, (SELECT ad_client.updatedby FROM ad_client WHERE ad_client.ad_client_id = sd.ad_client_id) AS updatedby, wh.m_warehouse_id, p.m_product_id, sum(sd.qtyonhand) AS m2, p.em_dmprod_tileoslab AS formato, p.em_dmprod_height * p.em_dmprod_width AS area,  CASE WHEN upper(p.em_dmprod_tileoslab) = 'TILE' THEN sum(round(sd.qtyonhand / (p.em_dmprod_height * p.em_dmprod_width) - 0.5, 0 * (p.em_dmprod_height * p.em_dmprod_width))) ELSE count(sd.m_storage_detail_id) END AS cantidad, (SELECT pp.pricelist FROM m_productprice pp WHERE pp.m_product_id = p.m_product_id AND (pp.m_pricelist_version_id IN (SELECT m_pricelist_version.m_pricelist_version_id FROM m_pricelist_version WHERE upper(m_pricelist_version.name) = 'VENTA EN DOLARES' AND m_pricelist_version.isactive = 'Y' ORDER BY m_pricelist_version.validfrom DESC LIMIT 1)) LIMIT 1) AS m2_precio, ((SELECT pp.pricelist FROM m_productprice pp WHERE pp.m_product_id = p.m_product_id AND (pp.m_pricelist_version_id IN (SELECT m_pricelist_version.m_pricelist_version_id FROM m_pricelist_version WHERE upper(m_pricelist_version.name) = 'VENTA EN DOLARES' AND m_pricelist_version.isactive = 'Y' ORDER BY m_pricelist_version.validfrom DESC LIMIT 1)) LIMIT 1)) * sum(sd.qtyonhand) AS total, sum(COALESCE(a.price, 0) * sd.qtyonhand) AS costo, p.em_dmprod_tipopiedra_id, p.em_dmprod_uso_id, p.em_dmprod_areauso_id, p.em_dmprod_color_id, p.em_dmprod_country_id, p.em_dmprod_tileoslab, p.em_dmprod_acabado, p.em_dmprod_isoutlet, p.em_dmprod_height, p.em_dmprod_width FROM m_storage_detail sd JOIN m_locator loc ON sd.m_locator_id = loc.m_locator_id JOIN m_warehouse wh ON loc.m_warehouse_id = wh.m_warehouse_id JOIN m_product p ON sd.m_product_id = p.m_product_id JOIN m_attributesetinstance asi ON sd.m_attributesetinstance_id = asi.m_attributesetinstance_id LEFT JOIN (SELECT COALESCE(c2.price, 0) AS price, COALESCE(iol2.m_attributesetinstance_id, pl2.m_attributesetinstance_id) AS m_attributesetinstance_id2 FROM m_costing c2 LEFT JOIN m_inoutline iol2 ON c2.m_inoutline_id = iol2.m_inoutline_id LEFT JOIN m_productionline pl2 ON pl2.m_productionline_id = c2.m_productionline_id) a ON a.m_attributesetinstance_id2 = sd.m_attributesetinstance_id WHERE sd.qtyonhand > 0 AND (upper(p.em_dmprod_tileoslab) IN ('TILE', 'SLAB')) GROUP BY wh.m_warehouse_id, p.m_product_id, p.em_dmprod_tipopiedra_id, p.em_dmprod_uso_id, p.em_dmprod_areauso_id, p.em_dmprod_color_id, p.em_dmprod_country_id, p.em_dmprod_tileoslab, p.em_dmprod_acabado, p.em_dmprod_isoutlet, p.em_dmprod_height, p.em_dmprod_width, p.em_dmprod_height * p.em_dmprod_width, sd.ad_client_id]]></view>
  </database>
