<?xml version="1.0"?>
  <database name="VIEW ALMAC_CRM_INVENTARIO">
    <view name="ALMAC_CRM_INVENTARIO"><![CDATA[SELECT pa.almac_piezasalmacenadas_id AS almac_crm_inventario_id, pa.ad_client_id, pa.ad_org_id, pa.createdby, pa.updatedby, pa.created, pa.updated, pa.isactive, pa.m_attributesetinstance_id, pa.prefijo, pa.numero, cal.name AS calidad, pa.alto, pa.ancho, p.em_dmprod_depth AS espesor, p.em_almac_p_revisado AS producto_revisado,  CASE WHEN upper(p.em_dmprod_tileoslab) = 'SLAB' THEN 1 ELSE pa.m2 / (COALESCE(pa.alto, 1) * COALESCE(pa.ancho, 1)) END AS cantidad, pa.m2, p.m_product_id, p.name AS nombre_comercial, p.sku AS sku_arca, p.value AS sku, pa.status, w.name AS almacen,  CASE WHEN cc.compra_contenedor_id IS NULL THEN 'NACIONAL' ELSE cc.documentno END AS contendor, pa.ventas_pickexecute_id, pe.pedido_cotizacion, COALESCE(pe.accion, 'NA') AS accion, almac_fecha_llegada(p.m_product_id, cc.compra_contenedor_id, w.m_warehouse_id, pa.em_almac_ingresado) AS almac_fecha_llegada, pa.pedido_mobiik, pa.anden_mobiik, pa.pedido_fecha_mobiik, pa.flete_mobiik, pa.flete_fecha_mobiik, pa.m_locator_id, w.m_warehouse_id FROM (SELECT  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN sd.m_storage_detail_id ELSE pl.compra_packinglist_id END AS almac_piezasalmacenadas_id, asi.m_attributesetinstance_id, asi.em_almac_calidad_p_id, asi.ad_client_id, asi.ad_org_id, asi.createdby, asi.updatedby, asi.created, asi.updated, p.isactive, 0.00 AS cantreservada, asi.em_almac_prefijo AS prefijo, asi.em_almac_numero AS numero, asi.em_ventas_pickexecute_id AS ventas_pickexecute_id, asi.em_almac_reservapedido AS reserva_pedido, asi.em_almac_reservacotizacion AS reserva_cotizacion,  CASE WHEN upper(p.em_dmprod_tileoslab) = 'SLAB' THEN asi.em_almac_alto ELSE p.em_dmprod_height END AS alto,  CASE WHEN upper(p.em_dmprod_tileoslab) = 'SLAB' THEN asi.em_almac_ancho ELSE p.em_dmprod_width END AS ancho, to_char('N') AS ob_selected,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN sd.qtyonhand ELSE pl.quantity END AS m2, p.m_product_id,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN wh.m_warehouse_id ELSE pl.m_warehouse_id END AS m_warehouse_id,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN 'ALMACENADO' ELSE 'TRANSITO' END AS status,  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN asi.em_almac_com_contenedor_id ELSE pl.compra_contenedor_id END AS compra_contenedor_id, '0' AS numero_pedido, '0' AS numero_cotizacion, 0 AS cantidad, wh.em_almac_esmonterrey, wh.em_almac_esdf, wh.em_almac_esguadalajara, wh.em_almac_escancun, asi.em_almac_ingresado, asi.em_almac_pedido AS pedido_mobiik, asi.em_almac_anden AS anden_mobiik, asi.em_almac_pedido_fecha AS pedido_fecha_mobiik, asi.em_almac_flete AS flete_mobiik, asi.em_almac_flete_fecha AS flete_fecha_mobiik, sd.m_locator_id FROM m_attributesetinstance asi LEFT JOIN (SELECT m_storage_detail.m_storage_detail_id, m_storage_detail.m_product_id, m_storage_detail.m_locator_id, m_storage_detail.m_attributesetinstance_id, m_storage_detail.qtyonhand FROM m_storage_detail WHERE round(m_storage_detail.qtyonhand, 4) > 0 AND m_storage_detail.m_attributesetinstance_id <> '0' AND m_storage_detail.ad_client_id = '0BD13E24E0F94596B61414BD72225EB8') sd ON sd.m_attributesetinstance_id = asi.m_attributesetinstance_id LEFT JOIN m_locator l ON l.m_locator_id = sd.m_locator_id LEFT JOIN m_warehouse wh ON wh.m_warehouse_id = l.m_warehouse_id LEFT JOIN (SELECT pl.m_attributesetinstance_id, pl.compra_packinglist_id, pl.quantity, pl.m_product_id, c.m_warehouse_id, c.compra_contenedor_id FROM compra_packinglist pl JOIN compra_contenedor c ON pl.compra_contenedor_id = c.compra_contenedor_id AND c.estado = 'CO') pl ON pl.m_attributesetinstance_id = asi.m_attributesetinstance_id LEFT JOIN m_product p ON p.m_product_id = COALESCE(sd.m_product_id, pl.m_product_id) WHERE  CASE WHEN COALESCE(asi.em_almac_ingresado, 'N') = 'Y' THEN sd.m_storage_detail_id ELSE pl.compra_packinglist_id END IS NOT NULL AND (upper(p.em_dmprod_tileoslab) IN ('TILE', 'SLAB')) AND p.isactive = 'Y') pa LEFT JOIN compra_contenedor cc ON cc.compra_contenedor_id = pa.compra_contenedor_id LEFT JOIN m_warehouse w ON w.m_warehouse_id = pa.m_warehouse_id LEFT JOIN m_product p ON p.m_product_id = pa.m_product_id AND (upper(p.em_dmprod_tileoslab) IN ('TILE', 'SLAB')) LEFT JOIN almac_calidad_p cal ON cal.almac_calidad_p_id = pa.em_almac_calidad_p_id LEFT JOIN ventas_pickexecute pe ON pe.ventas_pickexecute_id = pa.ventas_pickexecute_id]]></view>
  </database>
