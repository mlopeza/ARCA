<?xml version="1.0"?>
  <database name="TRIGGER ALMAC_MINOUT_PEDIDOPRECIO_TRG">
    <trigger name="ALMAC_MINOUT_PEDIDOPRECIO_TRG" table="M_INOUT" fires="before" insert="false" update="true" delete="false" foreach="row">
      <body><![CDATA[
v_cuenta NUMBER;
BEGIN
  IF AD_isTriggerEnabled()='N' THEN RETURN;
  END IF;

  IF (:NEW.issotrx = 'Y' AND :NEW.docstatus='CO') THEN
	--Verifica que tenga un pedido
	IF :NEW.em_almac_ventas_pick_id IS NULL THEN
		RAISE_APPLICATION_ERROR(-20000, 'No se puede completar la salida si no existe un nÃºmero de pedido.') ;
		RETURN OLD;
	END IF;
	--Cuenta los que no tienen precio
	SELECT COUNT(*) INTO v_cuenta FROM (select m_inoutline_id, em_almac_preciom2 FROM M_INOUTLINE WHERE M_INOUT_ID = :NEW.M_INOUT_ID) iol
			LEFT JOIN almac_distrib ad ON ad.m_inoutline_id = iol.m_inoutline_id AND (ad.costo_pieza is null OR iol.em_almac_preciom2 is null);
	IF (v_cuenta > 0 ) THEN
		RAISE_APPLICATION_ERROR(-20000, 'No se puede completar la salida si alguna pieza no tiene precio.') ;
		RETURN OLD;
	END IF;
	
  END IF;
  
END ALMAC_MINOUT_PEDIDOPRECIO_TRG
]]></body>
    </trigger>
  </database>
