<?xml version="1.0"?>
  <database name="TRIGGER VENTAS_H_DESG_TRG">
    <trigger name="VENTAS_H_DESG_TRG" table="VENTAS_HISTORIAL_DESGLOCE" fires="after" insert="true" update="true" delete="true" foreach="row">
      <body><![CDATA[ 
v_ol  VARCHAR(32);
v_suma NUMBER;
v_pendienteFacturar NUMBER;
        
BEGIN
    

	IF DELETING THEN
		v_ol = :OLD.VENTAS_ORDLINE_DETAIL_ID;
	ELSE
		v_ol = :NEW.VENTAS_ORDLINE_DETAIL_ID;
	END IF;

	SELECT SUM(QTY) INTO v_suma FROM VENTAS_HISTORIAL_DESGLOCE WHERE VENTAS_ORDLINE_DETAIL_ID = v_ol;

	UPDATE VENTAS_ORDLINE_DETAIL SET QTY_FACTURADO = COALESCE(v_suma,0), QTY_FACTURAR = QTY - COALESCE(v_suma,0) WHERE VENTAS_ORDLINE_DETAIL_ID = v_ol;

	--UPDATE VENTAS_ORDLINE_DETAIL SET QTY_FACTURADO = COALESCE(v_suma,0) WHERE VENTAS_ORDLINE_DETAIL_ID = v_ol;

	SELECT QTY - QTY_FACTURADO INTO v_pendienteFacturar FROM VENTAS_ORDLINE_DETAIL WHERE VENTAS_ORDLINE_DETAIL_ID = v_ol;

	IF (v_pendienteFacturar > 0) THEN
		UPDATE VENTAS_ORDLINE_DETAIL SET FACTURADO = 'Y' WHERE VENTAS_ORDLINE_DETAIL_ID = v_ol;
	ELSE
		UPDATE VENTAS_ORDLINE_DETAIL SET FACTURADO = 'N' WHERE VENTAS_ORDLINE_DETAIL_ID = v_ol;
	END IF;
	
	END VENTAS_H_DESG_TRG
]]></body>
    </trigger>
  </database>
