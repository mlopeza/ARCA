<?xml version="1.0"?>
  <database name="TRIGGER VENTAS_INVOICE_TRG">
    <trigger name="VENTAS_INVOICE_TRG" table="C_INVOICE" fires="after" insert="true" update="true" delete="false" foreach="row">
      <body><![CDATA[ V_DOCTSATUS VARCHAR(32);
BEGIN
  IF AD_isTriggerEnabled()='N' THEN RETURN;
  END IF;

  SELECT DOCSTATUS INTO V_DOCTSATUS FROM C_INVOICE WHERE C_INVOICE_ID = :NEW.C_INVOICE_ID;

  IF (V_DOCTSATUS = 'VO') THEN

	DELETE FROM VENTAS_HISTORIAL_DESGLOCE WHERE VENTAS_HISTORIAL_DESGLOCE_ID IN 
		(SELECT VENTAS_HISTORIAL_DESGLOCE_ID FROM VENTAS_HISTORIAL_DESGLOCE WHERE C_INVOICELINE_ID IN 
			(SELECT C_INVOICELINE_ID FROM C_INVOICELINE WHERE C_INVOICE_ID = :NEW.C_INVOICE_ID)) AND M_INOUTLINE_ID IS NULL;
	
	UPDATE VENTAS_HISTORIAL_DESGLOCE SET C_INVOICELINE_ID = NULL, C_INVOICE_ID = NULL WHERE VENTAS_HISTORIAL_DESGLOCE_ID 
		IN (SELECT VENTAS_HISTORIAL_DESGLOCE_ID FROM VENTAS_HISTORIAL_DESGLOCE WHERE C_INVOICELINE_ID
		IN (SELECT C_INVOICELINE_ID FROM C_INVOICELINE WHERE C_INVOICE_ID = :NEW.C_INVOICE_ID));
  END IF; 
  
END VENTAS_INVOICE_TRG
]]></body>
    </trigger>
  </database>
